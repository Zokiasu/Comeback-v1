<template>
    <div>
        <div id="button" class="flex flex-col md:flex-row space-y-5 md:space-y-0 justify-between p-10">
            <div>
                <t-datepicker
                    class="text-black"
                    v-model="dateStart"
                    placeholder="Start Date"
                    initial-view="month"
                    dateFormat='Y-m-d'
                    clearable>
                </t-datepicker>
            </div>
            <div>
                <t-select
                id="artists-type-selector"
                class="focus:outline-none"
                v-model="userPreference"
                :options="[
                    { value: false, text: 'All Comeback' },
                    { value: true, text: 'My Comeback' },
                ]">
                </t-select>
            </div>
        </div>
        <div id="release-date" class="space-y-5">
            <div v-for="(date, index) in dateList" :key="index" class="justify-center texts text-white mx-10 animate__animated animate__fadeIn">
                <div class="top-0 bg-mainbg z-50">
                    <h1 class="font-semibold text-2xl md:text-4xl"> {{new Date(index).toLocaleDateString('en-EN', {  month: 'long', day: 'numeric', year: 'numeric' })}} </h1>
                </div>
                <div class="w-full flex flex-wrap overflow-y-scroll py-5 texts text-white">
                    <ReleaseCard
                        class="mr-2 mb-5 lg:mr-5 lg:mb-0"
                        v-for="release in date.releases"
                        :release="release"
                        :key="release.id">
                    </ReleaseCard>
                </div>
            </div>
            <InfiniteLoading v-if="stopInfiniteScroll" @infinite="infiniteScroll"></InfiniteLoading>
            <div v-if="Object.entries(dateList).length < 1 && !stopInfiniteScroll" class="px-5 mt-5">
                <span style="background-color: #6B728033" class="text-white w-full flex justify-center rounded p-2">No Release Scheduled.</span>
            </div>
        </div>
    </div>
</template>

<script>
    import 'animate.css'
    import ScrollReveal from 'scrollreveal'
    import { mapGetters } from 'vuex'

    export default {

        head() {
            return {
                title: "Comeback - Calendar",
                meta: [
                    {
                        hid: 'description',
                        name: 'description',
                        content: "Find all the artists' releases by day and according to your preferences.",
                    }
                ]
            }
        },

        data(){
            return {
                userPreference: 'false',
                stopInfiniteScroll: true,
                dateStart: null,
                startDate: new Date(),
                endDate: new Date(),
                dateList: {},
                user: null,
                gapDate: 30,
                infiniteId: +new Date(),
            }
        },

        created(){
            this.user = this.GET_DATA_USER()
        },

        watch: {
            userPreference: {
                immediate: true,
                handler(userPreference) {
                    if (process.client) {
                        if(this.dateStart != null) {
                            this.startDate = new Date(this.dateStart)
                            this.endDate.setDate((this.startDate.getDate()) + 7)
                        }
                        this.fetchData()
                    }
                }
            },

            dateStart: {
                immediate: true,
                handler(dateStart) {
                    if (process.client) {
                        if(dateStart == null) {
                            let d = new Date();
                            let ye = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(d);
                            let mo = new Intl.DateTimeFormat('en', { month: 'numeric' }).format(d);
                            let da = new Intl.DateTimeFormat('en', { day: 'numeric' }).format(d);
                            if(da != 1) da = da-1
                            dateStart = `${ye}-${mo}-${da}`
                            this.dateStart = `${ye}-${mo}-${da}`
                        }
                        this.startDate = new Date(dateStart)
                        this.fetchData()
                    }
                }
            },
        },

        methods:{

            ...mapGetters([
                'GET_DATA_USER',
            ]),

            async fetchData() {
                let tmp = {}
                if(this.userPreference == 'true'){
                    this.$axios.get(`https://comeback-api.herokuapp.com/calendar/${this.user.id}?date_sup=${this.startDate}&date_inf=${this.endDate}`).then(response => {
                        if(Object.entries(response.data).length) {
                            this.dateList = {}
                            for(let [key, value] of Object.entries(response.data)) {
                                tmp[key] = value
                            }
                            this.dateList = tmp
                        } else {
                            this.dateList = {}
                        }
                    })
                    .catch(err => {
                        console.log(err);
                    });
                } else {
                    this.$axios.get(`https://comeback-api.herokuapp.com/calendar?date_sup=${this.startDate}&date_inf=${this.endDate}`).then(response => {
                        if(Object.entries(response.data).length) {
                            this.dateList = {}
                            for(let [key, value] of Object.entries(response.data)) {
                                tmp[key] = value
                            }
                            this.dateList = tmp
                        } else {
                            this.dateList = {}
                        }
                    })
                    .catch(err => {
                        console.log(err);
                    });
                }
                this.changeType()
            },

            infiniteScroll($state) {
                setTimeout(() => {
                    let tmp = this.dateList != null ? this.dateList : {}
                    if(this.userPreference == 'true'){
                        this.$axios.get(`https://comeback-api.herokuapp.com/calendar/${this.user.id}?date_sup=${this.startDate}&date_inf=${this.endDate}`).then(response => {
                            if(Object.entries(response.data).length !== 0) {
                                this.dateList = {}
                                for(let [key, value] of Object.entries(response.data)) {
                                    tmp[key] = value
                                }
                                this.dateList = tmp
                                this.startDate.setDate((this.startDate.getDate()) + this.gapDate)
                                this.endDate.setDate((this.endDate.getDate()) + this.gapDate)
                                $state.loaded();
                                this.stopInfiniteScroll = true
                            } else {
                                this.stopInfiniteScroll = false
                                $state.complete();
                            }
                        })
                        .catch(err => {
                            console.log(err);
                        });
                    } else {
                        this.$axios.get(`https://comeback-api.herokuapp.com/calendar?date_sup=${this.startDate}&date_inf=${this.endDate}`).then(response => {
                            if(Object.entries(response.data).length !== 0) {
                                this.dateList = {}
                                for(let [key, value] of Object.entries(response.data)) {
                                    tmp[key] = value
                                }
                                this.dateList = tmp
                                this.startDate.setDate((this.startDate.getDate()) + this.gapDate)
                                this.endDate.setDate((this.endDate.getDate()) + this.gapDate)
                                $state.loaded();
                                this.stopInfiniteScroll = true
                            } else {
                                this.stopInfiniteScroll = false
                                $state.complete();
                            }
                        })
                        .catch(err => {
                            console.log(err);
                        });
                    }
                }, 500);
            },

            changeType() {
                this.infiniteId += 1;
            },
        },
    }
</script>